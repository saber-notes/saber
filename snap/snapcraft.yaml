name: saber
base: core24
adopt-info: saber
grade: stable
confinement: strict
license: GPL-3.0
compression: lzo
icon: assets/icon/icon.svg
platforms:
  amd64:
  arm64:

parts:
  rustup:
    plugin: rust
    source: .
    rust-channel: "1.90"
    override-build: ""
    override-prime: ""

  saber:
    after: [rustup]
    source: https://github.com/saber-notes/saber.git
    source-tag: 'v0.26.10'
    plugin: flutter
    build-packages:
      - libsecret-1-dev
      - libjsoncpp-dev
      - libgstreamer1.0-dev
      - libgstreamer-plugins-base1.0-dev
      - openjdk-21-jdk
    build-snaps:
      - cmake
    stage-packages:
      - libjsoncpp25
      - zenity
    build-environment:
      - PATH: ${CRAFT_STAGE}/usr/bin:${PATH}
    override-build: |
      craftctl default
      mkdir -p $CRAFT_PART_INSTALL/meta/gui
      mv $CRAFT_PART_SRC/flatpak/com.adilhanney.saber.desktop $CRAFT_PART_INSTALL/meta/gui/saber.desktop
      mkdir $CRAFT_PART_INSTALL/metainfo
      mv $CRAFT_PART_SRC/flatpak/com.adilhanney.saber.metainfo.xml $CRAFT_PART_INSTALL/metainfo/
    parse-info: [metainfo/com.adilhanney.saber.metainfo.xml]

  cleanup:
    after:  # Make this part run last; list all your other parts here
      - saber
      - rustup
    plugin: nil
    build-snaps:
      - core24
      - gnome-46-2404
      - gtk-common-themes
    override-prime: |
      set -eux
      for snap in "core24" "gnome-46-2404" "gtk-common-themes" ; do
        cd "/snap/$snap/current" && find . -type f,l -exec rm -f "$SNAPCRAFT_PRIME/{}" \;
      done

apps:
  saber:
    command: saber
    desktop: meta/gui/saber.desktop
    extensions: [gnome]
    common-id: com.adilhanney.saber
    plugs:
      - home
      - network
      - network-status
